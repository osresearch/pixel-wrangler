#!/usr/bin/python3
# Decode the three TMDS channels and clock from a decode.bin dump
import os
import sys
from struct import unpack

time = 0

specials = {
0b1101010100: "Shv",
0b0010101011: "SHv",
0b0101010100: "ShV",
0b1010101011: "SHV",
0b1010011100: "T00",
0b1001100011: "T01",
0b1011100100: "T02",
0b1011100010: "T03",
0b0101110001: "T04",
0b0100011110: "T05",
0b0110001110: "T06",
0b0100111100: "T07",
0b1011001100: "T08",
0b0100111001: "T09",
0b0110011100: "T0A",
0b1011000110: "T0B",
0b1010001110: "T0C",
0b1001110001: "T0D",
0b0101100011: "T0E",
0b1011000011: "T0F",
}


def tmds(x):
#	wire invert = in[9];
#	wire use_xor = in[8];
#	wire [7:0] in_bits = invert ? ~in[7:0] : in;
#	wire [7:0] in_xor = { in_bits[6:0] ^ in_bits[7:1], in_bits[0] };
#	wire [7:0] in_xnor = { in_bits[6:0] ^~ in_bits[7:1], in_bits[0] };
#	wire [7:0] data_out = use_xor ? in_xor : in_xnor;

	invert = (x >> 9) & 1;
	use_xor = (x >> 8) & 1;

	x = (x & 0xFF)
	if invert:
		x = x ^ 0xFF

	x = (x ^ (x << 1)) & 0xFF

	if not use_xor:
		x ^= 0xFE

	return x

	

d0_ext = 0

def decode(b):
	global time, d0_ext
	cycle = (b >> 7) & 1
	clk = (b >> 6) & 1

	# collect the bit streams
	d0 = ((b >>  0) & 0x3FF) ^ 0x3FF # invert
	d1 = ((b >> 10) & 0x3FF) ^ 0x3FF # invert
	d2 = (b >> 20) & 0x3FF
	valid = (b >> 30) & 3

	d0_ext = ((d0_ext << 10) | d0) & 0xFFFFFFFF

	d0_str = specials.get(d0, "")
	d1_str = specials.get(d1, "")
	d2_str = specials.get(d2, "")

	print("%08x %s %s %s %s %02x %02x %02x %s%s%s %s" % (
		time, valid,
		format(d0, "03x"),
		format(d1, "03x"),
		format(d2, "03x"),
		tmds(d0), tmds(d1), tmds(d2),
		d0_str, d1_str, d2_str,
		format(d0_ext, "032b"),
	))
	time += 1

bits = b''
with open(sys.argv[1], "rb") as f:
	while True:
		if len(bits) < 6:
			bits += f.read(8)

		#print("bits=",bits)
		(hdr,msg) = unpack(">HI", bits[0:6])
		if hdr != 0:
			# trim off the front
			print("resync")
			bits = bits[1:]
			continue

		decode(msg)
		bits = bits[6:]


